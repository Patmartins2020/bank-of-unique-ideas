<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NDA - Bank of Unique Ideas</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #020617;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }
      .box {
        max-width: 720px;
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        padding: 28px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      h1 {
        font-size: 24px;
        margin: 0 0 10px;
        color: #34d399;
      }
      p {
        margin: 8px 0;
        font-size: 15px;
        color: rgba(255, 255, 255, 0.88);
        line-height: 1.55;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }
      a.btn,
      button.btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: white;
        text-decoration: none;
        cursor: pointer;
        font-size: 14px;
      }
      a.btn:hover,
      button.btn:hover {
        background: rgba(255, 255, 255, 0.10);
      }
      .btn-primary {
        border-color: rgba(52, 211, 153, 0.35);
        background: rgba(52, 211, 153, 0.12);
      }
      .btn-primary:hover {
        background: rgba(52, 211, 153, 0.18);
      }
      .btn-danger {
        border-color: rgba(248, 113, 113, 0.35);
        background: rgba(248, 113, 113, 0.10);
      }
      .btn-danger:hover {
        background: rgba(248, 113, 113, 0.16);
      }
      .status {
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.25);
        font-size: 14px;
      }
      .ok {
        color: #34d399;
        font-weight: 700;
      }
      .warn {
        color: #60a5fa;
        font-weight: 700;
      }
      .err {
        color: #f87171;
        font-weight: 700;
      }
      .muted {
        color: rgba(255, 255, 255, 0.65);
      }
      form {
        margin-top: 14px;
        padding-top: 14px;
        border-top: 1px dashed rgba(255, 255, 255, 0.18);
      }
      input[type="file"] {
        display: block;
        width: 100%;
        margin-top: 8px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.25);
        color: white;
      }
      .small {
        font-size: 12.5px;
      }
      .divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.10);
        margin: 16px 0;
      }
    </style>
  </head>

  <body>
    <div class="box">
      <h1>NDA Process</h1>
      <p class="muted">
        Use this page to download the NDA template, sign it, and upload the signed copy.
        After upload, our team will review and approve. Once approved, you’ll be redirected to the idea access page.
      </p>

      <div class="status" id="statusBox">
        <span class="warn" id="statusText">Reading NDA link…</span>
        <div class="small muted" id="statusSub"></div>
      </div>

      <div class="row">
        <!-- Template download always available -->
        <a class="btn btn-primary" href="/nda-template/NDA.pdf" target="_blank" rel="noreferrer">
          Download NDA Template (PDF)
        </a>

        <!-- Access button appears when approved -->
        <button class="btn" id="accessBtn" style="display:none;">
          Access Idea
        </button>

        <button class="btn" id="refreshBtn">
          Refresh Status
        </button>
      </div>

      <form id="uploadForm">
        <p><strong>Upload Signed NDA</strong></p>
        <p class="small muted">
          Allowed: PDF/JPG/PNG • Max 10MB
        </p>

        <!-- IMPORTANT: your /api/nda/upload expects requestId, not ndaId -->
        <input type="hidden" id="requestId" name="requestId" value="" />

        <input
          type="file"
          id="file"
          name="file"
          accept=".pdf,.png,.jpg,.jpeg,application/pdf,image/png,image/jpeg"
          required
        />

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" type="submit" id="uploadBtn">
            Upload Signed NDA
          </button>
          <button class="btn btn-danger" type="button" id="clearBtn">
            Clear File
          </button>
        </div>

        <div class="small muted" style="margin-top:10px;">
          If you already uploaded, don’t upload again. Just refresh status and wait for admin approval.
        </div>
      </form>

      <div class="divider"></div>

      <p class="small muted">
        If you reached this page from an email, your NDA ID is embedded in the link.
      </p>
    </div>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const msg = document.getElementById("msg");
    const form = document.getElementById("ndaForm");
    const ndaIdInput = document.getElementById("ndaId");
    const fileInput = document.getElementById("file");

    // Read ndaId from URL
    const urlParams = new URLSearchParams(window.location.search);
    const ndaId = urlParams.get("ndaId");

    if (ndaIdInput) ndaIdInput.value = ndaId || "";

    if (!ndaId) {
      if (msg) {
        msg.className = "error";
        msg.innerText = "Missing NDA ID in the link.";
      }
      // Don’t attach handlers if ndaId missing
      return;
    }

    // 1) Validate NDA access (keeps your current flow)
    (async function validateAccess() {
      if (msg) {
        msg.className = "loading";
        msg.innerText = "Validating your NDA access...";
      }

      try {
        const res = await fetch(`/api/nda/access?ndaId=${encodeURIComponent(ndaId)}`);
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          if (msg) {
            msg.className = "error";
            msg.innerText = data?.error || "Access denied.";
          }
          return;
        }

        // If your API sometimes wants to redirect (optional)
        if (data?.redirectTo) {
          window.location.href = data.redirectTo;
          return;
        }

        // Otherwise just show approved / pending message
        if (msg) {
          msg.className = "";
          msg.innerText = data?.message || "NDA approved. You can upload your signed NDA.";
        }
      } catch (err) {
        if (msg) {
          msg.className = "error";
          msg.innerText = "Network error validating NDA.";
        }
      }
    })();

    // 2) Upload signed NDA (this is the part your button is failing to trigger)
    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!fileInput || !fileInput.files || !fileInput.files[0]) {
          alert("Please choose a file first.");
          return;
        }

        const file = fileInput.files[0];

        const formData = new FormData();
        formData.append("ndaId", ndaId);
        formData.append("file", file);

        // Optional UI feedback
        const oldMsg = msg ? msg.innerText : "";
        if (msg) {
          msg.className = "loading";
          msg.innerText = "Uploading signed NDA...";
        }

        try {
          const res = await fetch("/api/nda/upload-signed", {
            method: "POST",
            body: formData,
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            if (msg) {
              msg.className = "error";
              msg.innerText = data?.error || "Upload failed.";
            }
            alert(data?.error || "Upload failed.");
            return;
          }

          if (msg) {
            msg.className = "";
            msg.innerText = "Upload received. Check your email for the access link.";
          }
          alert("Upload received. Check your email for the access link.");

          // Optional: clear the file input
          fileInput.value = "";
        } catch (err) {
          if (msg) {
            msg.className = "error";
            msg.innerText = "Upload failed due to network error.";
          }
          alert("Upload failed due to network error.");
        } finally {
          // restore previous message if needed
          // if (msg) msg.innerText = oldMsg;
        }
      });
    }
  });
</script>
  </body>
</html>