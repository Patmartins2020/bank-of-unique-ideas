<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NDA - Bank of Unique Ideas</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #020617;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }
      .box {
        max-width: 720px;
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        padding: 28px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      h1 {
        font-size: 24px;
        margin: 0 0 10px;
        color: #34d399;
      }
      p {
        margin: 8px 0;
        font-size: 15px;
        color: rgba(255, 255, 255, 0.88);
        line-height: 1.55;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }
      a.btn,
      button.btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: white;
        text-decoration: none;
        cursor: pointer;
        font-size: 14px;
      }
      a.btn:hover,
      button.btn:hover {
        background: rgba(255, 255, 255, 0.10);
      }
      .btn-primary {
        border-color: rgba(52, 211, 153, 0.35);
        background: rgba(52, 211, 153, 0.12);
      }
      .btn-primary:hover {
        background: rgba(52, 211, 153, 0.18);
      }
      .btn-danger {
        border-color: rgba(248, 113, 113, 0.35);
        background: rgba(248, 113, 113, 0.10);
      }
      .btn-danger:hover {
        background: rgba(248, 113, 113, 0.16);
      }
      .status {
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.25);
        font-size: 14px;
      }
      .ok {
        color: #34d399;
        font-weight: 700;
      }
      .warn {
        color: #60a5fa;
        font-weight: 700;
      }
      .err {
        color: #f87171;
        font-weight: 700;
      }
      .muted {
        color: rgba(255, 255, 255, 0.65);
      }
      form {
        margin-top: 14px;
        padding-top: 14px;
        border-top: 1px dashed rgba(255, 255, 255, 0.18);
      }
      input[type="file"] {
        display: block;
        width: 100%;
        margin-top: 8px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.25);
        color: white;
      }
      .small {
        font-size: 12.5px;
      }
      .divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.10);
        margin: 16px 0;
      }
    </style>
  </head>

  <body>
    <div class="box">
      <h1>NDA Process</h1>
      <p class="muted">
        Download the NDA template, sign it, and upload the signed copy.
        After you upload, our team will review your document.
        Once approved, you‚Äôll receive an email with access to the idea.
      </p>

      <div class="status" id="statusBox">
        <span class="warn" id="statusText">Reading NDA link‚Ä¶</span>
        <div class="small muted" id="statusSub"></div>
      </div>

      <div class="row">
        <a class="btn btn-primary" href="/nda-template/NDA.pdf" target="_blank" rel="noreferrer">
          Download NDA Template (PDF)
        </a>

        <button class="btn" id="accessBtn" style="display:none;">
          Access Idea
        </button>

        <button class="btn" id="refreshBtn" type="button">
          Refresh Status
        </button>
      </div>

      <form id="uploadForm">
        <p><strong>Upload Signed NDA</strong></p>
        <p class="small muted">Allowed: PDF/JPG/PNG ‚Ä¢ Max 10MB</p>

        <input type="hidden" id="requestId" name="requestId" value="" />

        <input
          type="file"
          id="file"
          name="file"
          accept=".pdf,.png,.jpg,.jpeg,application/pdf,image/png,image/jpeg"
          required
        />

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" type="submit" id="uploadBtn">
            Upload Signed NDA
          </button>
          <button class="btn btn-danger" type="button" id="clearBtn">
            Clear File
          </button>
        </div>

        <div class="small muted" style="margin-top:10px;" id="uploadHint">
          If you already uploaded, don‚Äôt upload again. Just refresh status and wait for admin approval.
        </div>
      </form>

      <div class="divider"></div>

      <p class="small muted">
        If you reached this page from an email, your NDA ID is embedded in the link.
      </p>
    </div>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const statusText = document.getElementById("statusText");
        const statusSub = document.getElementById("statusSub");
        const accessBtn = document.getElementById("accessBtn");
        const refreshBtn = document.getElementById("refreshBtn");

        const uploadForm = document.getElementById("uploadForm");
        const uploadBtn = document.getElementById("uploadBtn");
        const clearBtn = document.getElementById("clearBtn");
        const fileInput = document.getElementById("file");
        const requestIdInput = document.getElementById("requestId");
        const uploadHint = document.getElementById("uploadHint");

        const urlParams = new URLSearchParams(window.location.search);
        const ndaId = (urlParams.get("ndaId") || "").trim();

        function setStatus(kind, text, sub) {
          if (statusText) {
            statusText.className = kind; // ok | warn | err
            statusText.textContent = text || "";
          }
          if (statusSub) {
            statusSub.textContent = sub || "";
          }
        }

        function setUploadEnabled(enabled, hintText) {
          if (uploadBtn) uploadBtn.disabled = !enabled;
          if (uploadHint && hintText) uploadHint.textContent = hintText;
        }

        if (!ndaId) {
          setStatus("err", "Missing NDA ID in the link.", "Please use the link from your email.");
          setUploadEnabled(false, "Upload disabled: missing NDA link.");
          return;
        }

        if (requestIdInput) requestIdInput.value = ndaId;

        let lastAccessLink = "";

        async function checkStatus() {
          setStatus("warn", "Checking NDA status‚Ä¶", "");

          try {
            const res = await fetch(`/api/nda/access?ndaId=${encodeURIComponent(ndaId)}`, {
              method: "GET",
              cache: "no-store",
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              // If backend returns your common message
              const msg = String(data?.error || "Access check failed.");
              setStatus("err", msg, "");
              // Keep upload disabled by default on unknown error
              setUploadEnabled(false, "Upload disabled. Please refresh or contact support.");
              return;
            }

            // Some APIs return redirectTo
            if (data?.redirectTo) {
              window.location.href = data.redirectTo;
              return;
            }

            const status = String(data?.status || data?.ndaStatus || "").toLowerCase();
            const message = data?.message || "Status loaded.";

            lastAccessLink = data?.unlockLink || data?.accessLink || data?.url || "";

            // Access button logic (only show when link exists)
            if (lastAccessLink) {
              accessBtn.style.display = "inline-flex";
            } else if (data?.ideaId) {
              lastAccessLink = `/investor/ideas/${encodeURIComponent(data.ideaId)}?ndaId=${encodeURIComponent(ndaId)}`;
              accessBtn.style.display = "inline-flex";
            } else {
              accessBtn.style.display = "none";
            }

            // IMPORTANT: Upload allowed only when admin has approved request stage
            const allowUpload = status === "approved" || status === "confirmed";
            setUploadEnabled(
              allowUpload,
              allowUpload
                ? "You may upload your signed NDA now. After upload, please wait for admin review."
                : "Upload not available yet. Please wait for the approval email that contains this link."
            );

            // Messaging aligned to expected actions
            if (status === "approved" || status === "confirmed") {
              setStatus(
                "ok",
                "‚úÖ Request approved. Please upload your signed NDA.",
                "After upload, our team will review it and email you once approved."
              );
              return;
            }

            if (status === "signed") {
              setStatus(
                "warn",
                "üì© Upload received. Waiting for admin review‚Ä¶",
                "You‚Äôll receive an email once your signed NDA is approved."
              );
              setUploadEnabled(false, "Upload received. Please do not upload again. Wait for admin review.");
              return;
            }

            if (status === "verified") {
              setStatus(
                "ok",
                "‚úÖ Signed NDA approved. Access is available.",
                "Click ‚ÄúAccess Idea‚Äù if the button is available, or check your email for the access link."
              );
              setUploadEnabled(false, "Approved. No further upload is needed.");
              return;
            }

            if (status === "rejected" || status === "blocked") {
              setStatus(
                "err",
                "‚ùå Your NDA request was rejected/blocked.",
                "Please contact support or request again."
              );
              setUploadEnabled(false, "Upload disabled: request rejected/blocked.");
              return;
            }

            // Pending or unknown statuses
            if (status === "pending") {
              setStatus(
                "warn",
                "‚è≥ Request pending.",
                "Please wait for admin approval. You will be contacted by email."
              );
              setUploadEnabled(false, "Upload disabled until request is approved.");
              return;
            }

            setStatus("warn", message, status ? `Current status: ${status}` : "");
          } catch (e) {
            setStatus("err", "Network error while checking status.", "Please refresh and try again.");
            setUploadEnabled(false, "Upload disabled due to network error. Please try again.");
          }
        }

        // initial load
        checkStatus();

        if (refreshBtn) {
          refreshBtn.addEventListener("click", (e) => {
            e.preventDefault();
            checkStatus();
          });
        }

        if (accessBtn) {
          accessBtn.addEventListener("click", (e) => {
            e.preventDefault();
            if (lastAccessLink) {
              window.location.href = lastAccessLink;
            } else {
              setStatus("warn", "Access link not available yet.", "Please refresh after admin approval.");
            }
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener("click", () => {
            if (fileInput) fileInput.value = "";
          });
        }

        // ------------ UPLOAD ------------
        if (uploadForm) {
          uploadForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!fileInput || !fileInput.files || !fileInput.files[0]) {
              setStatus("err", "Please choose a file first.", "");
              return;
            }

            const file = fileInput.files[0];

            if (uploadBtn) uploadBtn.disabled = true;
            setStatus("warn", "Uploading signed NDA‚Ä¶", "Please wait.");

            try {
              const formData = new FormData();
              formData.append("requestId", ndaId);
              formData.append("file", file);

              const res = await fetch("/api/nda/upload", {
                method: "POST",
                body: formData,
              });

              const data = await res.json().catch(() => ({}));

              if (!res.ok) {
                const errMsg = String(data?.error || "Upload failed.");

                // Align the common ‚Äúnot allowed yet‚Äù case
                if (errMsg.toLowerCase().includes("not allowed yet")) {
                  setStatus(
                    "warn",
                    "‚è≥ Not ready yet.",
                    "Please wait for the admin approval email before uploading."
                  );
                  setUploadEnabled(false, "Upload disabled until admin approves your request.");
                } else {
                  setStatus("err", errMsg, data?.details ? String(data.details) : "");
                  // allow retry if it was a normal error
                  setUploadEnabled(false, "Upload failed. Please fix the issue and try again.");
                }

                return;
              }

              // success
              if (fileInput) fileInput.value = "";
              setStatus(
                "ok",
                "‚úÖ Upload received.",
                "Our team will review your signed NDA and contact you via email once approved."
              );
              setUploadEnabled(false, "Upload received. Please do not upload again. Wait for admin review.");
              await checkStatus();
            } catch (err) {
              setStatus("err", "Upload failed due to network error.", "Please try again.");
              setUploadEnabled(false, "Upload disabled due to network error. Please try again.");
            }
          });
        }
      });
    </script>
  </body>
</html>