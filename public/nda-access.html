<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NDA - Bank of Unique Ideas</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #020617;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }
      .box {
        max-width: 720px;
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        padding: 28px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      h1 {
        font-size: 24px;
        margin: 0 0 10px;
        color: #34d399;
      }
      p {
        margin: 8px 0;
        font-size: 15px;
        color: rgba(255, 255, 255, 0.88);
        line-height: 1.55;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }
      a.btn,
      button.btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: white;
        text-decoration: none;
        cursor: pointer;
        font-size: 14px;
      }
      a.btn:hover,
      button.btn:hover {
        background: rgba(255, 255, 255, 0.10);
      }
      .btn-primary {
        border-color: rgba(52, 211, 153, 0.35);
        background: rgba(52, 211, 153, 0.12);
      }
      .btn-primary:hover {
        background: rgba(52, 211, 153, 0.18);
      }
      .btn-danger {
        border-color: rgba(248, 113, 113, 0.35);
        background: rgba(248, 113, 113, 0.10);
      }
      .btn-danger:hover {
        background: rgba(248, 113, 113, 0.16);
      }
      .status {
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.25);
        font-size: 14px;
      }
      .ok {
        color: #34d399;
        font-weight: 700;
      }
      .warn {
        color: #60a5fa;
        font-weight: 700;
      }
      .err {
        color: #f87171;
        font-weight: 700;
      }
      .muted {
        color: rgba(255, 255, 255, 0.65);
      }
      form {
        margin-top: 14px;
        padding-top: 14px;
        border-top: 1px dashed rgba(255, 255, 255, 0.18);
      }
      input[type="file"] {
        display: block;
        width: 100%;
        margin-top: 8px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.25);
        color: white;
      }
      .small {
        font-size: 12.5px;
      }
      .divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.10);
        margin: 16px 0;
      }
    </style>
  </head>

  <body>
    <div class="box">
      <h1>NDA Process</h1>
      <p class="muted">
        Use this page to download the NDA template, sign it, and upload the signed copy.
        After upload, our team will review and approve. Once approved, you’ll be redirected to the idea access page.
      </p>

      <div class="status" id="statusBox">
        <span class="warn" id="statusText">Reading NDA link…</span>
        <div class="small muted" id="statusSub"></div>
      </div>

      <div class="row">
        <!-- Template download always available -->
        <a class="btn btn-primary" href="/nda-template/NDA.pdf" target="_blank" rel="noreferrer">
          Download NDA Template (PDF)
        </a>

        <!-- Access button appears when approved -->
        <button class="btn" id="accessBtn" style="display:none;">
          Access Idea
        </button>

        <button class="btn" id="refreshBtn">
          Refresh Status
        </button>
      </div>

      <form id="uploadForm">
        <p><strong>Upload Signed NDA</strong></p>
        <p class="small muted">
          Allowed: PDF/JPG/PNG • Max 10MB
        </p>

        <!-- IMPORTANT: your /api/nda/upload expects requestId, not ndaId -->
        <input type="hidden" id="requestId" name="requestId" value="" />

        <input
          type="file"
          id="file"
          name="file"
          accept=".pdf,.png,.jpg,.jpeg,application/pdf,image/png,image/jpeg"
          required
        />

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" type="submit" id="uploadBtn">
            Upload Signed NDA
          </button>
          <button class="btn btn-danger" type="button" id="clearBtn">
            Clear File
          </button>
        </div>

        <div class="small muted" style="margin-top:10px;">
          If you already uploaded, don’t upload again. Just refresh status and wait for admin approval.
        </div>
      </form>

      <div class="divider"></div>

      <p class="small muted">
        If you reached this page from an email, your NDA ID is embedded in the link.
      </p>
    </div>

    <script>
      const statusText = document.getElementById("statusText");
      const statusSub = document.getElementById("statusSub");
      const statusBox = document.getElementById("statusBox");

      const accessBtn = document.getElementById("accessBtn");
      const refreshBtn = document.getElementById("refreshBtn");

      const uploadForm = document.getElementById("uploadForm");
      const uploadBtn = document.getElementById("uploadBtn");
      const clearBtn = document.getElementById("clearBtn");
      const fileInput = document.getElementById("file");

      const requestIdInput = document.getElementById("requestId");

      // read ndaId from query: ?ndaId=xxxx
      const urlParams = new URLSearchParams(window.location.search);
      const ndaId = urlParams.get("ndaId") || "";

      requestIdInput.value = ndaId;

      function setStatus(kind, title, sub = "") {
        statusText.className = kind;
        statusText.textContent = title;
        statusSub.textContent = sub || "";
      }

      async function fetchNda() {
        if (!ndaId) {
          setStatus("err", "Missing NDA ID in the link.", "Please request a new NDA link.");
          uploadBtn.disabled = true;
          return null;
        }

        // Validate NDA exists + check status
        const res = await fetch(`/api/nda/get?id=${encodeURIComponent(ndaId)}`, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          setStatus("err", data?.error || "Invalid or expired NDA link.", "");
          uploadBtn.disabled = true;
          return null;
        }

        return data?.nda || null;
      }

      async function checkAccess() {
        // If approved + not expired, /api/nda/access returns redirectTo
        const res = await fetch(`/api/nda/access?ndaId=${encodeURIComponent(ndaId)}`, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return null;
        return data?.redirectTo || null;
      }

      async function refresh() {
        setStatus("warn", "Checking NDA status…", "");
        uploadBtn.disabled = false;

        const nda = await fetchNda();
        if (!nda) return;

        const st = (nda.status || "requested").toLowerCase();
        const signedPath = nda.signed_nda_path || null;

        if (st === "rejected") {
          setStatus("err", "This NDA request was rejected.", "You can request a new NDA if needed.");
          uploadBtn.disabled = true;
          accessBtn.style.display = "none";
          return;
        }

        if (st === "approved") {
          setStatus("ok", "NDA approved. You can access the idea now.", "");
          uploadBtn.disabled = true;
          accessBtn.style.display = "inline-flex";

          const redirectTo = await checkAccess();
          if (redirectTo) {
            // optional: auto-redirect
            window.location.href = redirectTo;
            return;
          }
          return;
        }

        if (st === "signed" || signedPath) {
          setStatus("warn", "Signed NDA received. Awaiting admin approval…", "Please check back shortly.");
          uploadBtn.disabled = true;
          accessBtn.style.display = "none";
          return;
        }

        // pending/requested
        setStatus("warn", "NDA link is valid. Please download, sign, and upload.", "");
        accessBtn.style.display = "none";
      }

      // Upload handler -> calls your existing POST /api/nda/upload (expects requestId + file)
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!ndaId) {
          alert("Missing ndaId in link.");
          return;
        }

        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          alert("Please choose a file.");
          return;
        }

        // client-side validation (matches your server validation)
        const maxBytes = 10 * 1024 * 1024;
        const allowed = ["application/pdf", "image/png", "image/jpeg"];
        if (!allowed.includes(file.type)) {
          alert("Only PDF, PNG, or JPG files are allowed.");
          return;
        }
        if (file.size > maxBytes) {
          alert("File too large (max 10MB).");
          return;
        }

        uploadBtn.disabled = true;
        setStatus("warn", "Uploading signed NDA…", "");

        const formData = new FormData();
        formData.append("file", file);
        formData.append("requestId", ndaId);

        const res = await fetch("/api/nda/upload", {
          method: "POST",
          body: formData,
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          uploadBtn.disabled = false;
          setStatus("err", data?.error || "Upload failed.", "");
          return;
        }

        setStatus("ok", "Upload received successfully.", "Admin will review and approve. You’ll get access after approval.");
        // After upload, re-check status
        await refresh();
      });

      clearBtn.addEventListener("click", () => {
        fileInput.value = "";
      });

      refreshBtn.addEventListener("click", async () => {
        await refresh();
      });

      accessBtn.addEventListener("click", async () => {
        const redirectTo = await checkAccess();
        if (!redirectTo) {
          alert("Access not active yet. Please wait for approval or refresh status.");
          return;
        }
        window.location.href = redirectTo;
      });

      // initial load
      refresh();
    </script>
  </body>
</html>