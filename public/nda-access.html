<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NDA - Bank of Unique Ideas</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #020617;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }
      .box {
        max-width: 720px;
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        padding: 28px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      h1 {
        font-size: 24px;
        margin: 0 0 10px;
        color: #34d399;
      }
      p {
        margin: 8px 0;
        font-size: 15px;
        color: rgba(255, 255, 255, 0.88);
        line-height: 1.55;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }
      a.btn,
      button.btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: white;
        text-decoration: none;
        cursor: pointer;
        font-size: 14px;
      }
      a.btn:hover,
      button.btn:hover {
        background: rgba(255, 255, 255, 0.10);
      }
      .btn-primary {
        border-color: rgba(52, 211, 153, 0.35);
        background: rgba(52, 211, 153, 0.12);
      }
      .btn-primary:hover {
        background: rgba(52, 211, 153, 0.18);
      }
      .btn-danger {
        border-color: rgba(248, 113, 113, 0.35);
        background: rgba(248, 113, 113, 0.10);
      }
      .btn-danger:hover {
        background: rgba(248, 113, 113, 0.16);
      }
      .status {
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.25);
        font-size: 14px;
      }
      .ok {
        color: #34d399;
        font-weight: 700;
      }
      .warn {
        color: #60a5fa;
        font-weight: 700;
      }
      .err {
        color: #f87171;
        font-weight: 700;
      }
      .muted {
        color: rgba(255, 255, 255, 0.65);
      }
      form {
        margin-top: 14px;
        padding-top: 14px;
        border-top: 1px dashed rgba(255, 255, 255, 0.18);
      }
      input[type="file"] {
        display: block;
        width: 100%;
        margin-top: 8px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.25);
        color: white;
      }
      .small {
        font-size: 12.5px;
      }
      .divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.10);
        margin: 16px 0;
      }
    </style>
  </head>

  <body>
    <div class="box">
      <h1>NDA Process</h1>
      <p class="muted">
        Use this page to download the NDA template, sign it, and upload the signed copy.
        After upload, our team will review and approve. Once confirmed, youâ€™ll be able to access the idea.
      </p>

      <div class="status" id="statusBox">
        <span class="warn" id="statusText">Reading NDA linkâ€¦</span>
        <div class="small muted" id="statusSub"></div>
      </div>

      <div class="row">
        <a class="btn btn-primary" href="/nda-template/NDA.pdf" target="_blank" rel="noreferrer">
          Download NDA Template (PDF)
        </a>

        <button class="btn" id="accessBtn" style="display:none;">
          Access Idea
        </button>

        <button class="btn" id="refreshBtn" type="button">
          Refresh Status
        </button>
      </div>

      <form id="uploadForm">
        <p><strong>Upload Signed NDA</strong></p>
        <p class="small muted">Allowed: PDF/JPG/PNG â€¢ Max 10MB</p>

        <!-- our /api/nda/upload accepts requestId OR ndaId -->
        <input type="hidden" id="requestId" name="requestId" value="" />

        <input
          type="file"
          id="file"
          name="file"
          accept=".pdf,.png,.jpg,.jpeg,application/pdf,image/png,image/jpeg"
          required
        />

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" type="submit" id="uploadBtn">
            Upload Signed NDA
          </button>
          <button class="btn btn-danger" type="button" id="clearBtn">
            Clear File
          </button>
        </div>

        <div class="small muted" style="margin-top:10px;">
          If you already uploaded, donâ€™t upload again. Just refresh status and wait for admin approval.
        </div>
      </form>

      <div class="divider"></div>

      <p class="small muted">
        If you reached this page from an email, your NDA ID is embedded in the link.
      </p>
    </div>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const statusText = document.getElementById("statusText");
        const statusSub = document.getElementById("statusSub");
        const accessBtn = document.getElementById("accessBtn");
        const refreshBtn = document.getElementById("refreshBtn");

        const uploadForm = document.getElementById("uploadForm");
        const uploadBtn = document.getElementById("uploadBtn");
        const clearBtn = document.getElementById("clearBtn");
        const fileInput = document.getElementById("file");
        const requestIdInput = document.getElementById("requestId");

        const urlParams = new URLSearchParams(window.location.search);
        const ndaId = (urlParams.get("ndaId") || "").trim();

        function setStatus(kind, text, sub) {
          if (statusText) {
            statusText.className = kind; // ok | warn | err
            statusText.textContent = text || "";
          }
          if (statusSub) {
            statusSub.textContent = sub || "";
          }
        }

        if (!ndaId) {
          setStatus("err", "Missing NDA ID in the link.", "Please use the link from your email.");
          if (uploadBtn) uploadBtn.disabled = true;
          return;
        }

        // âœ… set hidden requestId so /api/nda/upload works
        if (requestIdInput) requestIdInput.value = ndaId;

        // ------------ STATUS CHECK ------------
        // This assumes you already have /api/nda/access?ndaId=...
        // We handle many possible response shapes safely.
        let lastAccessLink = "";

        async function checkStatus() {
          setStatus("warn", "Checking NDA statusâ€¦", "");

          try {
            const res = await fetch(`/api/nda/access?ndaId=${encodeURIComponent(ndaId)}`, {
              method: "GET",
              cache: "no-store",
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              setStatus("err", data?.error || "Access check failed.", "");
              return;
            }

            // Some APIs return redirectTo
            if (data?.redirectTo) {
              window.location.href = data.redirectTo;
              return;
            }

            // Derive status
            const status = String(data?.status || data?.ndaStatus || "").toLowerCase();
            const message = data?.message || "Status loaded.";

            // If your access endpoint returns an unlock link, capture it
            lastAccessLink =
              data?.unlockLink ||
              data?.accessLink ||
              data?.url ||
              "";

            // Access button logic
            if (lastAccessLink) {
              accessBtn.style.display = "inline-flex";
            } else if (data?.ideaId) {
              // fallback: build link if ideaId present
              lastAccessLink = `/investor/ideas/${encodeURIComponent(data.ideaId)}?ndaId=${encodeURIComponent(ndaId)}`;
              accessBtn.style.display = "inline-flex";
            } else {
              accessBtn.style.display = "none";
            }

            // Upload enabled only when admin confirmed request stage
            // i.e. status === "confirmed"
            const allowUpload = status === "confirmed";
            if (uploadBtn) uploadBtn.disabled = !allowUpload;

            // UI messages
            if (status === "confirmed") {
              setStatus("ok", "âœ… NDA request confirmed. Please upload your signed copy.", message);
              return;
            }

            if (status === "signed") {
              setStatus("warn", "ðŸ“© Signed NDA received. Waiting for admin reviewâ€¦", message);
              return;
            }

            if (status === "verified") {
              setStatus("ok", "âœ… confirmed. Access is available.", message);
              return;
            }

            if (status === "blocked" || status === "blocked") {
              setStatus("err", "âŒ NDA request was blocked.", message);
              if (uploadBtn) uploadBtn.disabled = true;
              return;
            }

            // default
            setStatus("warn", message, status ? `Current status: ${status}` : "");
          } catch (e) {
            setStatus("err", "Network error while checking status.", "");
          }
        }

        // initial load
        checkStatus();

        // refresh button
        if (refreshBtn) {
          refreshBtn.addEventListener("click", (e) => {
            e.preventDefault();
            checkStatus();
          });
        }

        // access button
        if (accessBtn) {
          accessBtn.addEventListener("click", (e) => {
            e.preventDefault();
            if (lastAccessLink) {
              window.location.href = lastAccessLink;
            } else {
              setStatus("warn", "Access link not available yet.", "Please refresh status after admin approval.");
            }
          });
        }

        // clear file button
        if (clearBtn) {
          clearBtn.addEventListener("click", () => {
            if (fileInput) fileInput.value = "";
          });
        }

        // ------------ UPLOAD ------------
        // âœ… ONE endpoint only: /api/nda/upload
        if (uploadForm) {
          uploadForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!fileInput || !fileInput.files || !fileInput.files[0]) {
              setStatus("err", "Please choose a file first.", "");
              return;
            }

            const file = fileInput.files[0];

            // UI feedback
            if (uploadBtn) uploadBtn.disabled = true;
            setStatus("warn", "Uploading signed NDAâ€¦", "Please wait.");

            try {
              const formData = new FormData();
              formData.append("requestId", ndaId);
              formData.append("file", file);

              const res = await fetch("/api/nda/upload", {
                method: "POST",
                body: formData,
              });

              const data = await res.json().catch(() => ({}));

              if (!res.ok) {
                setStatus("err", data?.error || "Upload failed.", data?.details ? String(data.details) : "");
                if (uploadBtn) uploadBtn.disabled = false;
                return;
              }

              // success
              if (fileInput) fileInput.value = "";
              setStatus("ok", "âœ… Upload received.", "Now waiting for admin approval of the signed NDA.");
              await checkStatus();
            } catch (err) {
              setStatus("err", "Upload failed due to network error.", "");
              if (uploadBtn) uploadBtn.disabled = false;
            }
          });
        }
      });
    </script>
  </body>
</html>